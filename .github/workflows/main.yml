name: Transition Jira Ticket

on:
  pull_request:
    types: [opened]
  workflow_dispatch:

jobs:
  transition-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira Issue ID from Branch Name
        id: extract-issue-id
        run: |
          # Assuming branch name contains the Jira issue key in the format PROJECT-123
          ISSUE_KEY=$(echo "${{ github.head_ref }}" | grep -oE '[A-Z]+-[0-9]+')
          echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV

      - name: Transition Jira Ticket to "Done"
        if: env.ISSUE_KEY != ''
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_URL: ${{ secrets.JIRA_URL }}
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
        run: |
          curl -u "$JIRA_USER:$JIRA_API_TOKEN" \
          -X POST \
          -H "Content-Type: application/json" \
          --data '{"transition": {"id": "51"}}' \
          "$JIRA_URL/rest/api/2/issue/$ISSUE_KEY/transitions"
